<!--
TODO: 
give marker more useful information (picutre, directions)
  use directions service api
better favicon
-->

<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anywhere's Fine</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css?family=Oswald" rel="stylesheet">
    <link rel="icon" href="https://i.ibb.co/7CJYgMX/Restaurant-Favicon.png">
  </head>
  <body>
    <!--Loading screen-->
    <div id="loading">
      <div id="loadingMessage">
        <h1>Finding restaurants in your area...</h1>
        <div class="sk-folding-cube">
          <div class="sk-cube1 sk-cube"></div>
          <div class="sk-cube2 sk-cube"></div>
          <div class="sk-cube4 sk-cube"></div>
          <div class="sk-cube3 sk-cube"></div>
        </div>
      </div>
    </div>
    <div id="map"></div>
    <div id="modal">
      <div id="output"></div>
    </div>
    <div id="buttonC"></div>

    <script>
      var map, infoWindow, marker, service, pos, request, searchResults, marker, directionRequest;
      var randomIndex = 1;
      var randomNums = [];//array used to randomize restaurant selection
      var op = document.getElementById('output');

      function createMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: 0, lng: 0},
          zoom: 12
        });
        
        infowindow = new google.maps.InfoWindow();

        //HTML5 geolocation
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
            pos = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };
        map.setCenter(pos);
          });
        }

        waitForLoc();
      }

      //wait for the location of the user to be defined before continuing
      function waitForLoc() {
        if (typeof pos !== "undefined") {
          request = {
            location: pos,
            radius: 16093,//10 miles in meters
            type: ['restaurant']
          };
          service = new google.maps.places.PlacesService(map);
          service.nearbySearch(request, output);
        }
        else {
          setTimeout(waitForLoc, 1000);
        }
      }

      function output(results, status, pagination) {
        pagination.nextPage();
        //allow results array to be accessed outside of this function
        if (typeof searchResults === "undefined") {
          searchResults = results;
        }
        else {
          searchResults = searchResults.concat(results);
        }
        if (!pagination.hasNextPage) {
          //create array of random numbers to be used to cycle through restaurants
          while (randomNums.length < searchResults.length) {
            var n = Math.floor(Math.random() * searchResults.length);
            if (randomNums.indexOf(n) === -1) {
              randomNums.push(n);
            }
          }
          if (status == google.maps.places.PlacesServiceStatus.OK) {
            createMarker(searchResults[randomNums[0]]);
          }
          //remove loading screen
          var l = document.getElementById("loading");
          l.parentNode.removeChild(l);
          op.innerHTML = "<h3>How about...<h3><h1>" + searchResults[randomNums[0]].name + "</h1><h3>" + searchResults[randomNums[0]].vicinity + "</h3>";
          //make "find another restaurant" button appear
          addButtons();
        }
      }

      function createMarker(place) {
        //custom marker
        var foodIcon = {
          url: "https://i.ibb.co/JQzK0f7/Restaurant-Icon.png",
        }

        marker = new google.maps.Marker({
            map: map,
            position: place.geometry.location,
            animation: google.maps.Animation.DROP,
            icon: foodIcon
        });

        //center the map slightly above the restaurant location
        var mapCenter = {
          lat: place.geometry.location.lat()+.03,
          lng: place.geometry.location.lng()
        }
        map.setCenter(mapCenter);
        
        //set position for infowindow
        var iwLoc = {
          lat: place.geometry.location.lat()+.008,
          lng: place.geometry.location.lng()
        }

        /*
        //directions api
        var directionsService = new google.maps.DirectionsService;
        var directionsDisplay = new google.maps.DirectionsRenderer;
        directionsDisplay.setMap(map);
        directionRequest = {
          origin: pos,
          destination: place.geometry.location,
          travelMode: google.maps.TravelMode.DRIVING
        }
        directionsService.route(directionRequest, function(response) {
          directionsDisplay.setDirections(response)
        });
        */
        /*
        marker.addListener('click', function() {
          infowindow.setOptions({
            position: iwLoc
          });
          infowindow.open(map);
        })
        */
      }

      function newPlace() {
        //remove marker, reset zoom, close infowindow
        marker.setMap(null);
        map.zoom=12;
        infowindow.close(map);
        var place = searchResults[randomNums[randomIndex]];
        //loop through array of restaurants
        op.innerHTML = "<h3>How about...<h3><h1>" + place.name + "</h1><h3>" + place.vicinity + "<h3>";
        createMarker(place);
        if (randomIndex < searchResults.length-1) {
          randomIndex += 1;
        }
        else {
          randomIndex = 0;
        }
      }

      //function to create and add the "find another restaurant" and "get directions" buttons
      function addButtons() {
        var btn1 = document.createElement("BUTTON");
        var btn2 = document.createElement("BUTTON");
        var t1 = document.createTextNode("GET DIRECTIONS");
        var t2 = document.createTextNode("FIND ANOTHER RESTAURANT");
        btn1.appendChild(t1);
        btn1.setAttribute("class", "button");
        btn2.appendChild(t2);
        btn2.setAttribute("class", "button");
        btn2.setAttribute("onclick", "newPlace()");
        var btns = document.getElementById("buttonC");
        btns.appendChild(btn1);
        btns.appendChild(btn2);
      }

    </script>

    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBYt9VVQ99uazPcofKhJrS4AIGCa9AC6hQ&libraries=places&callback=createMap">
    </script>
  </body>
  
</script>
</html>